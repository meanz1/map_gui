<html>

<head>
    <link rel="stylesheet" type="text/css" href="../css/index.css" />
    <script type="text/javascript" src="../js/eventemitter2.js"></script>
    <script type="text/javascript" src="../js/roslib.js"></script>
    <script type="text/javascript" src="../js/ros3d.js"></script>
    <!--<script async src="../js/opencv.js" onload="onOpenCvReady();" type="text/javascipt"></script>-->
</head>

<body>
    <header>header</header>
    <main>
        <div id="src">
            <h2>Canvas</h2>
            <canvas id="canvas"></canvas>
            <img id="canvas_img"></img>
        </div>
        <div id="btn">
            <button id="get_map" onclick="btn_func(this.id)">Get map</button>
            <button id="save" onclick="btn_func(this.id)">Save</button>
            <p id="draw">Draw</p>
            <button id="line" onclick="drawLine()">Line</button>
            <button id="square" onclick="drawSquare()">Square</button>
            <button id="eraser" onclick="erase()">Eraser</button>
            <div id="map">
                <canvas id="mini_can"></canvas>
                <img id="mini_can_img"></img>
            </div>


        </div>

        <script>

            var ros = new ROSLIB.Ros({
                url: 'ws://localhost:9090'
            });

            ros.on('connection', function () {
                console.log('Connected to websocket server');
            })

            ros.on('error', function (error) {
                console.log('error ros server');
            })

            ros.on('close', function () {
                console.log('Connection to websocket server closed');
            })

            var canvas = document.getElementById("canvas");
            var ctx = canvas.getContext("2d");

            var mini_can = document.getElementById("mini_can");
            var mini_ctx = mini_can.getContext("2d");

            canvas.width = 500;
            canvas.height = 500;

            mini_can.width = 200;
            mini_can.height = 200;
            var resolution;
            var pos = new Array();
            var miniarray = new Array();

            ctx.lineWidth = 1; // 컨버스에 그리는 라인의 두께 설정
            ctx.strokeStyle = "#006cb7";

            mini_ctx.lineWidth = 1;
            mini_ctx.strokeStyle = "#006cb7";
            var drag = false;
            var stX, stY;
            var miniX, miniY, mapX, mapY;
            var line = false;
            var square = false;
            var cnt = 0;

            var mapimg = new ROSLIB.Topic({
                ros: ros,
                name: "/map_pgm/compressed",
                messageType: "sensor_msgs/CompressedImage",
            });

            var mapsize = new ROSLIB.Topic({
                ros: ros,
                name: "/mapsize",
                messageType: "std_msgs/Float32MultiArray",
            })

            var mapPos = new ROSLIB.Topic({
                ros: ros,
                name: "/mappos",
                messageType: "std_msgs/String",
            })

            var mapBig = new ROSLIB.Topic({
                ros: ros,
                name: "/map_big/compressed",
                messageType: "sensor_msgs/CompressedImage",
            })
            mapimg.subscribe((m) => {
                console.log("hell");
                document.getElementById("mini_can_img").src = "data:image/jpg;base64," + m.data;
            });
            mapBig.subscribe((m) => {
                console.log("map_big");
                document.getElementById("canvas_img").src = "data:image/jpg;base64," + m.data;
            });

            mapsize.subscribe((m) => {
                miniarray[0] = m.data[0];
                miniarray[1] = m.data[1];
                mini_can.width = m.data[0];
                mini_can.height = m.data[1];
                resolution = m.data[2];

            })

            canvas.addEventListener("mousedown", function (me) {
                mDown(me)
            }, false);

            mini_can.addEventListener("mousedown", function (me) {
                mDown_mini(me)
            }, false);




            function mDown(me) {
                mini_can.width = miniarray[0];
                mini_can.height = miniarray[1];
                document.getElementById("canvas").style.zIndex = 1;
                cnt++;
                stX = me.offsetX; //눌렀을 때 현재 마우스 X좌표를 stX에 담음
                stY = me.offsetY; //눌렀을 때 현재 마우스 Y좌표를 stY에 담음
                pos[cnt] = [stX, stY];
                if (line) {
                    ctx.beginPath();
                    ctx.arc(stX, stY, 4, 0, Math.PI * 2, true);
                    ctx.fill();
                    ctx.closePath();

                    if (cnt == 2) {
                        ctx.lineWidth = 3;
                        ctx.strokeStyle = "rgb(0, 255, 0)";
                        ctx.beginPath();
                        ctx.moveTo(pos[1][0], pos[1][1]);
                        ctx.lineTo(pos[2][0], pos[2][1]);
                        ctx.stroke();
                        cnt = 0;
                    }
                }

                if (square) {
                    ctx.beginPath();
                    ctx.arc(stX, stY, 4, 0, Math.PI * 2, true);
                    ctx.fill();
                    ctx.closePath();

                    if (cnt == 4) {
                        ctx.lineWidth = 3;
                        ctx.strokeStyle = "rgb(0, 255, 0)";
                        ctx.beginPath();
                        ctx.moveTo(pos[1][0], pos[1][1]);
                        ctx.lineTo(pos[2][0], pos[2][1]);
                        ctx.moveTo(pos[2][0], pos[2][1]);
                        ctx.lineTo(pos[3][0], pos[3][1]);
                        ctx.moveTo(pos[3][0], pos[3][1]);
                        ctx.lineTo(pos[4][0], pos[4][1]);
                        ctx.moveTo(pos[4][0], pos[4][1]);
                        ctx.lineTo(pos[1][0], pos[1][1]);
                        ctx.stroke();
                        cnt = 0;
                    }
                }
                console.log(stX, stY);

            }


            function mDown_mini(me) {
                mini_can.width = miniarray[0];
                mini_can.height = miniarray[1];
                document.getElementById("mini_can").style.zIndex = 1;
                miniX = me.offsetX;
                miniY = me.offsetY;
                mini_ctx.fillStyle = 'blue';
                mini_ctx.beginPath();
                mini_ctx.arc(miniX, miniY, 2, 0, Math.PI * 2, true);
                mini_ctx.fill();
                mini_ctx.closePath();

                mapX = miniX / resolution;
                mapY = miniY / resolution;
                console.log(mapX);

                const mapMsg = {
                    type: "map_draw",
                    width: canvas.width,
                    height: canvas.height,
                    x: mapX,
                    y: mapY,
                }
                var msg_map = JSON.stringify(mapMsg)
                var String_map = new ROSLIB.Message({
                    data: msg_map,
                });

                mapPos.publish(String_map);
                console.log("Pub message: ", String_map);

            }

            function drawLine() {
                cnt = 0;
                line = true;
                square = false;
                document.getElementById("line").style.backgroundColor = "blue";
                document.getElementById("square").style.backgroundColor = "white";
                document.getElementById("eraser").style.backgroundColor = "white";
            }

            function drawSquare() {
                cnt = 0;
                square = true;
                line = false;
                document.getElementById("line").style.backgroundColor = "white";
                document.getElementById("square").style.backgroundColor = "blue";
                document.getElementById("eraser").style.backgroundColor = "white";
            }

            function erase() {
                square = false;
                line = false;
                document.getElementById("line").style.backgroundColor = "white";
                document.getElementById("square").style.backgroundColor = "white";
                document.getElementById("eraser").style.backgroundColor = "blue";
            }

            function test() {
                square = false;
                line = false;
                document.getElementById("line").style.backgroundColor = "white";
                document.getElementById("square").style.backgroundColor = "white";
                document.getElementById("test").style.backgroundColor = "blue";
            }

            function btn_func(mode) {
                var ros_func = new ROSLIB.Topic({
                    ros: ros,
                    name: "/btnInput",
                    messageType: "std_msgs/String",
                });

                if (mode == 'get_map') {
                    const messages = {
                        type: mode,
                        width: canvas.width,
                        height: canvas.height,
                        x: 10,
                        y: 10,
                    }
                    var messages_str = JSON.stringify(messages)
                    var String_getmap = new ROSLIB.Message({
                        data: messages_str,
                    });

                    ros_func.publish(String_getmap);
                    console.log("Pub message: ", String_getmap);


                }

                if (mode == 'save') {
                    console.log('save');


                }









            }









        </script>

    </main>
    <footer>footer</footer>

</body>

</html>