<html>

<head>
    <link rel="stylesheet" type="text/css" href="../css/index.css" />
    <script type="text/javascript" src="../js/eventemitter2.js"></script>
    <script type="text/javascript" src="../js/roslib.js"></script>
    <script type="text/javascript" src="../js/ros3d.js"></script>
    <!--<script async src="../js/opencv.js" onload="onOpenCvReady();" type="text/javascipt"></script>-->
</head>

<body>
    <header>header</header>
    <main>
        <div id="src">
            <h2>Canvas</h2>
            <canvas id="canvas"></canvas>
            <img id="canvas_img"></img>
        </div>
        <div id="btn">
            <button id="get_map" onclick="btn_func(this.id)">Get map</button>
            <button id="save" onclick="btn_func(this.id)">Save</button>
            <p id="draw">Draw</p>
            <button id="line" onclick="drawLine()">Line</button>
            <button id="square" onclick="drawSquare()">Square</button>
            <button id="eraser" onclick="erase()">Eraser</button>

        </div>

        <script>

            var ros = new ROSLIB.Ros({
                url: 'ws://localhost:9090'
            });

            ros.on('connection', function () {
                console.log('Connected to websocket server');
            })

            ros.on('error', function (error) {
                console.log('error ros server');
            })

            ros.on('close', function () {
                console.log('Connection to websocket server closed');
            })




            var canvas = document.getElementById("canvas");
            var ctx = canvas.getContext("2d");

            canvas.width = 500;
            canvas.height = 500;
            var pos = new Array();

            ctx.lineWidth = 1; // 컨버스에 그리는 라인의 두께 설정
            ctx.strokeStyle = "#006cb7"
            var drag = false;
            var stX;
            var stY;
            var line = false;
            var square = false;
            var cnt = 0;

            var mapimg = new ROSLIB.Topic({
                ros: ros,
                name: "/map_pgm/compressed",
                messageType: "sensor_msgs/CompressedImage",
            });

            mapimg.subscribe((m) => {
                console.log("hell");
                document.getElementById("canvas_img").src = "data:image/jpg;base64," + m.data;
            });


            canvas.addEventListener("mousedown", function (me) {
                mDown(me)
            }, false);

            function mDown(me) {
                document.getElementById("canvas").style.zIndex = 1;
                cnt++;
                stX = me.offsetX; //눌렀을 때 현재 마우스 X좌표를 stX에 담음
                stY = me.offsetY; //눌렀을 때 현재 마우스 Y좌표를 stY에 담음
                pos[cnt] = [stX, stY];
                if (line) {
                    ctx.beginPath();
                    ctx.arc(stX, stY, 4, 0, Math.PI * 2, true);
                    ctx.fill();
                    ctx.closePath();

                    if (cnt == 2) {
                        ctx.lineWidth = 3;
                        ctx.strokeStyle = "rgb(0, 255, 0)";
                        ctx.beginPath();
                        ctx.moveTo(pos[1][0], pos[1][1]);
                        ctx.lineTo(pos[2][0], pos[2][1]);
                        ctx.stroke();
                        cnt = 0;
                    }
                }

                if (square) {
                    ctx.beginPath();
                    ctx.arc(stX, stY, 4, 0, Math.PI * 2, true);
                    ctx.fill();
                    ctx.closePath();

                    if (cnt == 4) {
                        ctx.lineWidth = 3;
                        ctx.strokeStyle = "rgb(0, 255, 0)";
                        ctx.beginPath();
                        ctx.moveTo(pos[1][0], pos[1][1]);
                        ctx.lineTo(pos[2][0], pos[2][1]);
                        ctx.moveTo(pos[2][0], pos[2][1]);
                        ctx.lineTo(pos[3][0], pos[3][1]);
                        ctx.moveTo(pos[3][0], pos[3][1]);
                        ctx.lineTo(pos[4][0], pos[4][1]);
                        ctx.moveTo(pos[4][0], pos[4][1]);
                        ctx.lineTo(pos[1][0], pos[1][1]);
                        ctx.stroke();
                        cnt = 0;
                    }
                }


                // if (cntLine == 2) {
                //     console.log("line");
                //     ctx.lineWidth = 10;
                //     ctx.strokeStyle = "rgb(0, 255, 0)";
                //     ctx.beginPath();
                //     ctx.moveTo(stX, stY);
                //     ctx.lineTo(me.offsetX, me.offsetY);
                //     ctx.stroke();

                // }
                console.log(stX, stY);

            }

            function drawLine() {
                cnt = 0;
                line = true;
                square = false;
                document.getElementById("line").style.backgroundColor = "blue";
                document.getElementById("square").style.backgroundColor = "white";
                document.getElementById("eraser").style.backgroundColor = "white";
            }

            function drawSquare() {
                cnt = 0;
                square = true;
                line = false;
                document.getElementById("line").style.backgroundColor = "white";
                document.getElementById("square").style.backgroundColor = "blue";
                document.getElementById("eraser").style.backgroundColor = "white";
            }

            function erase() {
                square = false;
                line = false;
                document.getElementById("line").style.backgroundColor = "white";
                document.getElementById("square").style.backgroundColor = "white";
                document.getElementById("eraser").style.backgroundColor = "blue";
            }

            function test() {
                square = false;
                line = false;
                document.getElementById("line").style.backgroundColor = "white";
                document.getElementById("square").style.backgroundColor = "white";
                document.getElementById("test").style.backgroundColor = "blue";
            }

            function btn_func(mode) {
                var ros_func = new ROSLIB.Topic({
                    ros: ros,
                    name: "/btnInput",
                    messageType: "std_msgs/String",
                });

                if (mode == 'get_map') {
                    const messages = {
                        type: mode,
                        width: canvas.width,
                        height: canvas.height,
                    }
                    var messages_str = JSON.stringify(messages)
                    var String_getmap = new ROSLIB.Message({
                        data: messages_str,
                    });

                    ros_func.publish(String_getmap);
                    console.log("Pub message: ", String_getmap);


                }

                if (mode == 'save') {
                    console.log('save');


                }









            }









        </script>

    </main>
    <footer>footer</footer>

</body>

</html>